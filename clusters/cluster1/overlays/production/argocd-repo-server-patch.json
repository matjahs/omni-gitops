[
  {
    "op": "add",
    "path": "/spec/template/spec/initContainers/-",
    "value": {
      "name": "download-tools",
      "image": "alpine:3.20",
      "command": ["sh", "-c"],
      "args": [
        "wget -O argocd-vault-plugin https://github.com/argoproj-labs/argocd-vault-plugin/releases/download/v1.18.1/argocd-vault-plugin_1.18.1_linux_amd64 && chmod +x argocd-vault-plugin && mv argocd-vault-plugin /custom-tools/"
      ],
      "volumeMounts": [
        {
          "mountPath": "/custom-tools",
          "name": "custom-tools"
        }
      ]
    }
  },
  {
    "op": "add",
    "path": "/spec/template/spec/volumes/-",
    "value": {
      "name": "custom-tools",
      "emptyDir": {}
    }
  },
  {
    "op": "add",
    "path": "/spec/template/spec/containers/0/volumeMounts/-",
    "value": {
      "mountPath": "/usr/local/bin/argocd-vault-plugin",
      "name": "custom-tools",
      "subPath": "argocd-vault-plugin"
    }
  },
  {
    "op": "add",
    "path": "/spec/template/spec/containers/0/env",
    "value": [
      {"name": "AVP_TYPE", "value": "vault"},
      {"name": "AVP_AUTH_TYPE", "value": "k8s"},
      {"name": "AVP_K8S_ROLE", "value": "argocd"},
      {"name": "VAULT_ADDR", "value": "http://172.16.0.4:8200"},
      {"name": "AVP_K8S_MOUNT_PATH", "value": "kubernetes"},
      {
        "name": "REDIS_PASSWORD",
        "valueFrom": {
          "secretKeyRef": {
            "name": "argocd-redis",
            "key": "auth"
          }
        }
      },
      {"name": "ARGOCD_REDIS", "value": "argocd-redis-ha-haproxy:6379"},
      {"name": "ARGOCD_REDIS_ADDR", "value": "argocd-redis-ha-haproxy:6379"}
    ]
  },
  {
    "op": "add",
    "path": "/spec/template/spec/containers/0/command",
    "value": [
      "/usr/local/bin/argocd-repo-server"
    ]
  },
  {
    "op": "replace",
    "path": "/spec/template/spec/containers/0/args",
    "value": [
      "--redis",
      "argocd-redis-ha-haproxy:6379"
    ]
  }
]
